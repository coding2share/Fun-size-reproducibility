---
title: AJPH tweet reproduction
author: Coding2Share
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
   
  html_notebook: 
    code_folding: hide
    highlight: pygments
    fig_caption: yes
    df_print: tibble
    toc: yes
    toc_float: 
      collapsed: true
      smooth_scroll: true
---
[//]: # CSS style arguments

<style type="text/css">

body{ /* Normal  */
      font-size: 20px;
      counter-reset:table figure;
  }

.table{
  width:auto;
  font-size:12px;
}

caption::before{
  counter-increment: table;
  content: "Table " counter(table) ": ";
}

.caption::before{
  counter-increment: figure;
  content: "Figure " counter(figure) ": ";
}

caption, .caption{
  font-style:italic;
  font-size: 16px;
  margin-top:0.5em;
  margin-bottom:0.5em;
  width:90%;
  text-align: left;
}

#TOC {
  font-size: 17px;
  width: 100%;
}

</style>

##Overview
This is a brief reproduction of data analysis featured in a [tweet from AJPH](https://twitter.com/AMJPublicHealth/status/900073839593349120) on August 22, 2017. The tweeted graph is from http://ajph.aphapublications.org/doi/10.2105/AJPH.2017.303981; the authors used data from [NHANES 2013-2014](https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2013) to estimate the distribution of the hours spent sedentary by American adults (age 20 and over). 

We reproduced the graph from the tweet using [R 3.4.1](https://www.r-project.org/) and the following packages: [*Hmisc*](https://cran.r-project.org/web/packages/Hmisc/Hmisc.pdf) (for reading in the SAS export data), [*survey*](https://cran.r-project.org/web/packages/survey/survey.pdf) (for calculating the weighted proportions and standard errors), & [*tidyverse*](https://www.tidyverse.org/) (for everything else).

```{r, echo=F}
knitr::opts_chunk$set(fig.width=12, fig.height=8, warning=FALSE, message=FALSE)

```

```{r, results='hide', echo=F}
'# PROLOG   ################################################################'   

'# PROJECT: OPEN SCIENCE #'   
'# PURPOSE: REPRODUCE APHA TWEET AUG 22 2017 #'   
'# DIR:     G:/CPHSS/OpenScience/Repros #'   
'# DATA:    https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/PAQ_H.XPT #'   
'#          https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/DEMO_H.XPT #'   
'# AUTHOR:  Todd Combs #'   
'# CREATED: AUG 23, 2017 #'   
'# LATEST:  AUG 23, 2017 #'   
'# NOTES:    #'   

'# PROLOG   ###############################################################'   
```

###Libraries & data management

Here we load the libraries, read in the public use data from the Nhanes website, wrangle it into a useful dataset and specify the survey design.
```{r libs&data, results='hide'}
library(tidyverse)
library(Hmisc)
library(survey)
theme_set(theme_minimal()) # set ggtheme
paq_h <- as_tibble(sasxport.get("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/PAQ_H.XPT")) #physical activity questions
demo_h <- as_tibble(sasxport.get("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/DEMO_H.XPT")) #weights

sithours <- c('0 to <3','3 to <6','6 to <9','9 to <12','12 to <15','15+') #create labels

nhanes <- paq_h %>%
  left_join(demo_h) %>% #merge
  mutate(pad680 = ifelse(pad680>1200,NA, pad680)) %>% #recode NAs
  mutate(hours = pad680/60) %>% # recode mins to hrs
  mutate(sit = ifelse(hours<3,sithours[1],
                      ifelse(hours>=3 & hours<6, sithours[2],
                             ifelse(hours>=6 & hours <9, sithours[3],
                                    ifelse(hours>=9 & hours<12, sithours[4],
                                           ifelse(hours>=12 & hours<15, 
                                                  sithours[5],sithours[6])))))) %>% #recode to categories with labels
  mutate(sit = factor(sit, levels=sithours)) %>% #factor for correct order
  filter(ridageyr>=20) #filter on 20+ years old

#summary(nhanes$ridageyr)


nh <- nhanes %>%
  select(seqn, sit, wtint2yr) #keep necessary vars

nh <- svydesign(~seqn, data = nh, weights = ~wtint2yr) #set svy design


```

###Analysis

Here we calculate the percentages and confidence intervals for the grouped hours in the original graph.
```{r analysis}



sit2 <- tibble(cat = levels(nh$variables$sit), pc=NA, lb=NA, ub=NA)

sit2[1,2:4] <- c(as.numeric(svyciprop(~I(sit == "0 to <3" ),nh)), attr(svyciprop(~I(sit == "0 to <3"),nh),'ci'))
sit2[2,2:4] <- c(as.numeric(svyciprop(~I(sit == "3 to <6" ),nh)), attr(svyciprop(~I(sit == "3 to <6"),nh),'ci'))
sit2[3,2:4] <- c(as.numeric(svyciprop(~I(sit == "6 to <9" ),nh)), attr(svyciprop(~I(sit == "6 to <9"),nh),'ci'))
sit2[4,2:4] <- c(as.numeric(svyciprop(~I(sit == "9 to <12" ),nh)), attr(svyciprop(~I(sit == "9 to <12"),nh),'ci'))
sit2[5,2:4] <- c(as.numeric(svyciprop(~I(sit == "12 to <15" ),nh)), attr(svyciprop(~I(sit == "12 to <15"),nh),'ci'))
sit2[6,2:4] <- c(as.numeric(svyciprop(~I(sit == "15+" ),nh)), attr(svyciprop(~I(sit == "15+"),nh),'ci'))
prop2pc <- function(x) {x*100}
sit2 <- sit2 %>%
  mutate_at(vars(pc:ub), prop2pc) %>%
  mutate(cat=factor(cat, levels=cat))
```

###Plot

And the plot.
```{r, fig.cap="Percentage of US Adults Aged 20 Years or Older Reporting Sitting or Reclining, by Hours Each Day, in 2013 to 2014: National Health and Nutrition Examination Survey"}

g <- sit2 %>%
  ggplot(aes(x=cat, y=pc, ymin=lb, ymax=ub))

g <- g + geom_col() +
  geom_errorbar(aes(width=0.25), size=1.5) + 
  geom_text(aes(label=round(pc,1)), size=10, nudge_y = 5,
            show.legend = F)

g <- g + labs(y="Percentage", x="Hours per Day Sitting") +
  theme(text = element_text(size=24))

g

```



